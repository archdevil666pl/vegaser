<?xml version="1.0" encoding="UTF-8"?>

<project name="Vegas CMF" default="build">

    <!-- ============================================  -->
    <!-- Target: build                                 -->
    <!-- ============================================  -->
    <target name="build">
        <echo msg="Building application directory" />
        <copy todir="./app">
            <fileset dir="./stub/project/app">
                <include name="**" />
            </fileset>
        </copy>
        <copy todir="./cli">
            <fileset dir="./stub/project/cli">
                <include name="**" />
            </fileset>
        </copy>
        <copy todir="./public">
            <fileset dir="./stub/project/public">
                <include name="**" />
            </fileset>
        </copy>
        <copy file="./stub/project/.htaccess" todir="./" />

        <echo msg="Making tests directory" />
        <mkdir dir="./stub/project/tests" />

        <echo msg="Making cache directory" />
        <mkdir dir="./cache" />
        <chmod file="./cache" mode="0777" />

        <touch file="./app/config/modules.php" />
        <touch file="./app/config/services.php" />
        <chmod file="./app/config" mode="0777" />

        <echo msg="Making fixtures directory" />
        <mkdir dir="./tests/fixtures" />

        <echo msg="Downloading composer" />
        <exec command="curl -sS https://getcomposer.org/installer | php" />

        <copy verbose="false" file="./stub/project/.gitignore" tofile="./.gitignore" overwrite="true" />
        <copy verbose="false" file="./stub/LICENSE" tofile="./LICENSE" overwrite="true" />
        <copy verbose="false" file="./stub/project/tests/bootstrap.php" tofile="./tests/bootstrap.php" overwrite="true" />
        <copy verbose="false" file="./stub/project/tests/config.php" tofile="./tests/config.php" overwrite="true" />
        <copy verbose="false" file="./stub/project/tests/config.php" tofile="./tests/config.sample.php" overwrite="true" />

        <input
                message="Enter name of project (eg. vegas-demo):"
                defaultValue="VegasApp"
                propertyName="config.name"/>

        <input
                message="Enter description of project"
                defaultValue="Project based on Vegas CMF"
                propertyName="config.description"/>

        <input
                message="Enter project domain"
                defaultValue="vegasdemo.com"
                propertyName="config.domain"/>

        <input
                message="Choose a database ${line.separator}
                1. Mongo${line.separator}
                2. Mysql${line.separator}
                3. Postgresql${line.separator}
                4. Sqlite${line.separator}
                5. Oracle${line.separator}"
                defaultValue="1"
                propertyName="config.db" />

        <input
                message="Enter project locale"
                defaultValue="nl_NL"
                propertyName="config.locale" />

        <input
                message="Enter your name:"
                defaultValue="Amsterdam Standard Vegas Team"
                propertyName="config.author_name" />

        <input
                message="Enter your email:"
                defaultValue="vegas@amsterdam-standard.pl"
                propertyName="config.author_email" />

        <echo msg="Generating composer configuration" />
        <copy verbose="false" file="./stub/project/composer.json" tofile="./composer.json" overwrite="true">
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="config.name" value="${config.name}" />
                    <token key="config.description" value="${config.description}" />
                    <token key="config.author_name" value="${config.author_name}" />
                    <token key="config.author_email" value="${config.author_email}" />
                </replacetokens>
            </filterchain>
        </copy>

        <echo msg="Generating phpunit configuration" />
        <copy verbose="false" file="./stub/project/phpunit.xml.dist" tofile="./phpunit.xml.dist" overwrite="true">
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="config.description" value="${config.description}" />
                </replacetokens>
            </filterchain>
        </copy>

        <echo msg="Initializing database" />
        <if>
            <equals arg1="${config.db}" arg2="1" />
            <then>
                <echo message="Mongo" />
                <copy verbose="false"
                      file="./stub/project/app/db/MongoServiceProvider.php"
                      tofile="./app/services/MongoServiceProvider.php"
                      overwrite="true" />
                <copy verbose="false"
                      file="./stub/project/app/db/CollectionManagerServiceProvider.php"
                      tofile="./app/services/CollectionManagerServiceProvider.php"
                      overwrite="true" />
                <copy verbose="false"
                      file="./stub/project/app/db/app/modules/Auth/models/collection/BaseUser.php"
                      tofile="./app/modules/Auth/models/BaseUser.php"
                      overwrite="true" />
                <copy verbose="false"
                      file="./stub/project/app/db/app/modules/Auth/services/collection/Auth.php"
                      tofile="./app/modules/Auth/services/Auth.php"
                      overwrite="true" />
                <property name="config.adapter" value="" />
            </then>
            <elseif>
                <equals arg1="${config.db}" arg2="2" />
                <then>
                    <echo message="Mysql" />
                    <copy verbose="false"
                          file="./stub/project/app/db/MysqlServiceProvider.php"
                          tofile="./app/services/DbServiceProvider.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/ModelsManagerServiceProvider.php"
                          tofile="./app/services/ModelsManagerServiceProvider.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/app/modules/Auth/models/model/BaseUser.php"
                          tofile="./app/modules/Auth/models/BaseUser.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/app/modules/Auth/services/model/Auth.php"
                          tofile="./app/modules/Auth/services/Auth.php"
                          overwrite="true" />
                    <property name="config.adapter" value="Mysql" />
                </then>
            </elseif>
            <elseif>
                <equals arg1="${config.db}" arg2="3" />
                <then>
                    <echo message="Postgresql" />
                    <copy verbose="false"
                          file="./stub/project/app/db/PostgresqlServiceProvider.php"
                          tofile="./app/services/DbServiceProvider.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/ModelsManagerServiceProvider.php"
                          tofile="./app/services/ModelsManagerServiceProvider.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/app/modules/Auth/models/model/BaseUser.php"
                          tofile="./app/modules/Auth/models/BaseUser.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/app/modules/Auth/services/model/Auth.php"
                          tofile="./app/modules/Auth/services/Auth.php"
                          overwrite="true" />
                    <property name="config.adapter" value="Postgresql" />
                </then>
            </elseif>
            <elseif>
                <equals arg1="${config.db}" arg2="4" />
                <then>
                    <echo message="Sqlite" />
                    <copy verbose="false"
                          file="./stub/project/app/db/SqliteServiceProvider.php"
                          tofile="./app/services/DbServiceProvider.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/ModelsManagerServiceProvider.php"
                          tofile="./app/services/ModelsManagerServiceProvider.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/app/modules/Auth/models/model/BaseUser.php"
                          tofile="./app/modules/Auth/models/BaseUser.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/app/modules/Auth/services/model/Auth.php"
                          tofile="./app/modules/Auth/services/Auth.php"
                          overwrite="true" />
                    <property name="config.adapter" value="Sqlite" />
                </then>
            </elseif>
            <elseif>
                <equals arg1="${config.db}" arg2="5" />
                <then>
                    <echo message="Oracle" />
                    <copy verbose="false"
                          file="./stub/project/app/db/OracleServiceProvider.php"
                          tofile="./app/services/DbServiceProvider.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/ModelsManagerServiceProvider.php"
                          tofile="./app/services/ModelsManagerServiceProvider.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/app/modules/Auth/models/model/BaseUser.php"
                          tofile="./app/modules/Auth/models/BaseUser.php"
                          overwrite="true" />
                    <copy verbose="false"
                          file="./stub/project/app/db/app/modules/Auth/services/model/Auth.php"
                          tofile="./app/modules/Auth/services/Auth.php"
                          overwrite="true" />
                    <property name="config.adapter" value="Oracle" />
                </then>
            </elseif>
        </if>

        <echo msg="Generating config file" />
        <copy verbose="false" file="./stub/project/app/config/config.php" tofile="./app/config/config.php" overwrite="true">
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="config.domain" value="${config.domain}" />
                    <token key="config.adapter" value="${config.adapter}" />
                    <token key="config.locale" value="${config.locale}" />
                </replacetokens>
            </filterchain>
        </copy>
        <copy verbose="false" file="./app/config/config.php" tofile="./app/config/config.sample.php" overwrite="true" />

        <echo msg="Generating readme file" />
        <copy verbose="false" file="./stub/README.md" tofile="./README.md" overwrite="true">
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="config.description" value="${config.description}" />
                </replacetokens>
            </filterchain>
        </copy>

        <mkdir dir="./vendor" mode="0777" />
        <mkdir dir="./app/tasks" mode="0777" />
        <touch file="./app/config/modules.php" />
        <touch file="./app/config/services.php" />
        <chmod file="./app/config" mode="0777" />
        <chmod file="./app/config/modules.php" mode="0777" />
        <chmod file="./app/config/services.php" mode="0777" />

        <echo msg="Cleaning up..." />
        <exec command="rm build.xml" />
        <exec command="rm -rf stub" />
        <exec command="rm -rf app/db" />

        <echo msg="********************************************************" />
        <echo msg="Everything is done." />
        <echo msg="Run `php composer.phar install` to install vendors" />
        <echo msg="Enjoy using Vegas CMF!" />
    </target>
</project>
