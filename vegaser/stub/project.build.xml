<?xml version="1.0" encoding="UTF-8"?>

<project name="Vegas CMF" default="build">

    <!-- ============================================  -->
    <!-- Target: build                                 -->
    <!-- ============================================  -->
    <target name="build">
        <echo msg="Building application directory" />
        <copy todir="./app">
            <fileset dir="./stub/project/app">
                <include name="**" />
            </fileset>
        </copy>
        <copy todir="./public">
            <fileset dir="./stub/project/public">
                <include name="**" />
            </fileset>
        </copy>
        <copy file="./stub/project/.htaccess" todir="./" />

        <echo msg="Making tests directory" />
        <mkdir dir="./stub/project/tests" />

        <echo msg="Making cache directory" />
        <mkdir dir="./cache" />
        <chmod file="./cache" mode="0777" />
        <chmod file="./app/config" mode="0777" />

        <echo msg="Making fixtures directory" />
        <mkdir dir="./tests/fixtures" />

        <echo msg="Downloading composer" />
        <exec command="curl -sS https://getcomposer.org/installer | php" />

        <copy verbose="false" file="./stub/.gitignore" tofile="./.gitignore" overwrite="true" />
        <copy verbose="false" file="./stub/LICENSE" tofile="./LICENSE" overwrite="true" />
        <copy verbose="false" file="./stub/project/tests/bootstrap.php" tofile="./tests/bootstrap.php" overwrite="true" />
        <copy verbose="false" file="./stub/project/tests/config.php" tofile="./tests/config.php" overwrite="true" />

        <input
                message="Enter a name of project (eg. vegas-demo):"
                propertyName="config.name"/>

        <input
                message="Enter a description of profject"
                defaultValue="Project based on Vegas CMF"
                propertyName="config.description"/>

        <input
                message="Enter your name:"
                defaultValue="Amsterdam Standard Vegas Team"
                propertyName="config.author_name" />

        <input
                message="Enter your email:"
                defaultValue="vegas@amsterdam-standard.pl"
                propertyName="config.author_email" />

        <echo msg="Generating composer configuration" />
        <copy verbose="false" file="./stub/project/composer.json" tofile="./composer.json" overwrite="true">
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="config.name" value="${config.name}" />
                    <token key="config.description" value="${config.description}" />
                    <token key="config.author_name" value="${config.author_name}" />
                    <token key="config.author_email" value="${config.author_email}" />
                </replacetokens>
            </filterchain>
        </copy>

        <echo msg="Generating phpunit configuration" />
        <copy verbose="false" file="./stub/project/phpunit.xml.dist" tofile="./phpunit.xml.dist" overwrite="true">
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="config.description" value="${config.description}" />
                </replacetokens>
            </filterchain>
        </copy>

        <echo msg="Generating readme file" />
        <copy verbose="false" file="./stub/README.md" tofile="./README.md" overwrite="true">
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <token key="config.description" value="${config.description}" />
                </replacetokens>
            </filterchain>
        </copy>

        <mkdir dir="./vendor" mode="0777" />
        <echo msg="Installing vendors" />
        <exec passthru="true" level="verbose" command="php composer.phar install" />

        <echo msg="Cleaning up..." />
        <exec command="rm build.xml" />
        <exec command="rm -rf stub" />

        <echo msg="********************************************************" />
        <echo msg="Everything is done." />
        <echo msg="If you experienced any problems during installing vendors, try run `php composer.phar install` once again (you can try with `sudo`)" />
        <echo msg="Enjoy using Vegas CMF!" />
    </target>
</project>
